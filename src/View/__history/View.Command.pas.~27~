unit View.Command;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, View.Default, Vcl.StdCtrls, Vcl.ExtCtrls,
  System.ImageList, Vcl.ImgList, Behavioral.Command.Calculadora, Behavioral.Command.Invoker;

type
  TOperacaoPendente = (opNone, opAdd, opSub);

  TfrmCommand = class(TfrmDefault)
    Panel1: TPanel;
    Panel2: TPanel;
    memLog: TMemo;
    edtDisplay: TEdit;
    Label1: TLabel;
    btnMais: TButton;
    btn7: TButton;
    btn8: TButton;
    btn9: TButton;
    btn4: TButton;
    btn5: TButton;
    btn6: TButton;
    btn1: TButton;
    btn2: TButton;
    btn3: TButton;
    btn0: TButton;
    btnVirgula: TButton;
    btnMenos: TButton;
    btnTotal: TButton;
    btnClear: TButton;
    ImageList1: TImageList;
    btnUndo: TButton;
    procedure FormCreate(Sender: TObject);
    procedure FormDestroy(Sender: TObject);
    procedure btnVirgulaClick(Sender: TObject);
    procedure btnMaisClick(Sender: TObject);
    procedure DigitClick(Sender: TObject);
    procedure btnMenosClick(Sender: TObject);
    procedure btnTotalClick(Sender: TObject);
    procedure btnClearClick(Sender: TObject);
    procedure btnUndoClick(Sender: TObject);
  private
    { Private declarations }
    FCalc        : TCalculadora;
    FInvoker     : TInvoker;
    FPendente    : TOperacaoPendente;
    FDigitando   : Boolean;

    function  TextoParaInteiro: Integer;
    procedure LimparEntrada;
    procedure AtualizarDisplayComTotal;
    procedure Log(const AMsg: string);
    procedure WireDigits;
    procedure AplicarPendenteComEntrada; // aplica +/− N via Command
    procedure PrepararOperacao(AOp: TOperacaoPendente);
  public
    { Public declarations }
  end;

var
  frmCommand: TfrmCommand;

implementation

{$R *.dfm}

uses Behavioral.Command.Soma, Behavioral.Command.Subtracao;

procedure TfrmCommand.AplicarPendenteComEntrada;
var
  LNumero, LAntes: Integer;
begin
  // Aplica a operação pendente com o número digitado, via Command
  if (FPendente = opNone) or (not FDigitando) then
    Exit;

  LNumero := TextoParaInteiro;
  LAntes := FCalc.Valor;

  case FPendente of
    opAdd:
      begin
        FInvoker.Compute(TSoma.Create(FCalc, LNumero));
        Log(Format('= (aplica +%d)  %d -> %d  (stack=%d)', [LNumero, LAntes, FCalc.Valor, FInvoker.Count]));
      end;
    opSub:
      begin
        FInvoker.Compute(TSubtracao.Create(FCalc, LNumero));
        Log(Format('= (aplica -%d)  %d -> %d  (stack=%d)', [LNumero, LAntes, FCalc.Valor, FInvoker.Count]));
      end;
  end;

  AtualizarDisplayComTotal;
  LimparEntrada;
  FPendente := opNone;
end;

procedure TfrmCommand.AtualizarDisplayComTotal;
begin
  edtDisplay.Text := IntToStr(FCalc.Valor);
end;

procedure TfrmCommand.btnClearClick(Sender: TObject);
begin
  inherited;
  FCalc.Reset;
  FreeAndNil(FInvoker);
  FInvoker   := TInvoker.Create;
  FPendente  := opNone;
  FDigitando := False;

  LimparEntrada;
  AtualizarDisplayComTotal;
  Log('Clear: zera total e histórico.');
end;

procedure TfrmCommand.btnMaisClick(Sender: TObject);
begin
  inherited;
  PrepararOperacao(opAdd);
  Log('Operação pendente: +');
end;

procedure TfrmCommand.btnMenosClick(Sender: TObject);
begin
  inherited;
  PrepararOperacao(opSub);
  Log('Operação pendente: -');
end;

procedure TfrmCommand.btnTotalClick(Sender: TObject);
begin
  inherited;
  if FPendente = opNone then
  begin
    AtualizarDisplayComTotal;
    Log(Format('= (sem pendência) -> Total=%d', [FCalc.Valor]));
    Exit;
  end;

  AplicarPendenteComEntrada;
end;

procedure TfrmCommand.btnUndoClick(Sender: TObject);
var
  LAntes: Integer;
begin
  inherited;
  LAntes := FCalc.Valor;
  FInvoker.Undo(1);
  FPendente := opNone; // depois de desfazer, não há operação pendente
  FDigitando := False;
  AtualizarDisplayComTotal;
  Log(Format('Undo: %d -> %d  (stack=%d)', [LAntes, FCalc.Valor, FInvoker.Count]));
end;

procedure TfrmCommand.btnVirgulaClick(Sender: TObject);
begin
  if Pos(',', edtDisplay.Text) = 0 then
  begin
    if not FDigitando then
      edtDisplay.Text := '0';
    edtDisplay.Text := edtDisplay.Text + ',';
    FDigitando := True;
  end;
end;

procedure TfrmCommand.DigitClick(Sender: TObject);
var
  LDigito: Char;
begin
  LDigito := Char(Ord('0') + TButton(Sender).Tag);
  if (edtDisplay.Text = '0') or (not FDigitando) then
    edtDisplay.Text := LDigito
  else
    edtDisplay.Text := edtDisplay.Text + LDigito;

  FDigitando := True;
end;

procedure TfrmCommand.FormCreate(Sender: TObject);
begin
  inherited;

  FCalc      := TCalculadora.Create;
  FInvoker   := TInvoker.Create;
  FPendente  := opNone;
  FDigitando := False;

  edtDisplay.ReadOnly  := True;
  // edtDisplay.Alignment := taRightJustify;
  edtDisplay.Text      := '0';

  memLog.Clear; memLog.ScrollBars := ssVertical;

  WireDigits;

  // garante handlers (caso DFM não tenha ligado)
  btnTotal.OnClick := btnTotalClick;
  btnClear.OnClick := btnClearClick;
  btnUndo.OnClick  := btnUndoClick;

  Log('Command: a tela cria comandos (TSoma/TSubtracao), envia ao Invoker e pode desfazer com Undo.');
end;

procedure TfrmCommand.FormDestroy(Sender: TObject);
begin
  FreeAndNil(FInvoker);
  FreeAndNil(FCalc);
  inherited;
end;

procedure TfrmCommand.LimparEntrada;
begin
  edtDisplay.Text := '0';
  FDigitando := False;
end;

procedure TfrmCommand.Log(const AMsg: string);
begin
  memLog.Lines.Add(AMsg);
end;

procedure TfrmCommand.PrepararOperacao(AOp: TOperacaoPendente);
begin
  // Se havia uma operação pendente e o usuário digitou algo, aplica antes (encadeamento)
  AplicarPendenteComEntrada;

  // Se não há total ainda e há número recém-digitado, inicia o acumulador
  if (FPendente = opNone) and FDigitando and (FCalc.Valor = 0) then
    FCalc.Valor := TextoParaInteiro;

  // Define a nova operação e prepara próxima entrada
  FPendente  := AOp;
  FDigitando := False;
  AtualizarDisplayComTotal; // mostra o acumulado
end;

function TfrmCommand.TextoParaInteiro: Integer;
begin
  Result := StrToIntDef(StringReplace(edtDisplay.Text, ',', '', []), 0);
end;

procedure TfrmCommand.WireDigits;
begin
  btn0.Caption := '0'; btn0.Tag := 0; btn0.OnClick := DigitClick;
  btn1.Caption := '1'; btn1.Tag := 1; btn1.OnClick := DigitClick;
  btn2.Caption := '2'; btn2.Tag := 2; btn2.OnClick := DigitClick;
  btn3.Caption := '3'; btn3.Tag := 3; btn3.OnClick := DigitClick;
  btn4.Caption := '4'; btn4.Tag := 4; btn4.OnClick := DigitClick;
  btn5.Caption := '5'; btn5.Tag := 5; btn5.OnClick := DigitClick;
  btn6.Caption := '6'; btn6.Tag := 6; btn6.OnClick := DigitClick;
  btn7.Caption := '7'; btn7.Tag := 7; btn7.OnClick := DigitClick;
  btn8.Caption := '8'; btn8.Tag := 8; btn8.OnClick := DigitClick;
  btn9.Caption := '9'; btn9.Tag := 9; btn9.OnClick := DigitClick;

  btnVirgula.Caption := ',';
  btnMais.Caption    := '+';
  btnMenos.Caption   := '-';
  btnTotal.Caption   := '=';
  btnClear.Caption   := 'C';
  btnUndo.Caption    := EmptyStr;

  // segurança extra: se o DFM não estiver ligado, forçamos aqui também
  btnTotal.OnClick := btnTotalClick;
  btnClear.OnClick := btnClearClick;
  btnUndo.OnClick  := btnUndoClick;
end;

end.
