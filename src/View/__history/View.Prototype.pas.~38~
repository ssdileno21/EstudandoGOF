unit View.Prototype;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, View.Default, Vcl.StdCtrls,
  Vcl.ExtCtrls, Vcl.Buttons;

type
  TfrmPrototype = class(TfrmDefault)
    GroupBox1: TGroupBox;
    Panel1: TPanel;
    btnSi: TImage;
    btnDo: TImage;
    btnRe: TImage;
    btnMi: TImage;
    btnFa: TImage;
    btnSol: TImage;
    btnLa: TImage;
    lstSequencia: TListBox;
    Panel2: TPanel;
    btnLimpar: TButton;
    btnCancelar: TButton;
    btnIniciar: TButton;
    memLog: TMemo;
    procedure FormCreate(Sender: TObject);
    procedure ImgNotaClick(Sender: TObject);
    procedure btnIniciarClick(Sender: TObject);
    procedure btnCancelarClick(Sender: TObject);
    procedure btnLimparClick(Sender: TObject);
  private
    { Private declarations }
    FSequencia: string;
    FReproduzindo: Boolean;
    procedure AtualizaBotoes;
    procedure TocarNota(const ANomeNota: string);
  public
    { Public declarations }
  end;

var
  frmPrototype: TfrmPrototype;

implementation

{$R *.dfm}

uses Prototype.NotaMusical, Prototype.Partitura, System.StrUtils,
Winapi.MMSystem;

{ TfrmPrototype }


procedure TfrmPrototype.AtualizaBotoes;
begin
  btnIniciar.Enabled := (FSequencia <> EmptyStr) and (not FReproduzindo);
  btnCancelar.Enabled := FReproduzindo;
  btnLimpar.Enabled := (FSequencia <> EmptyStr) and (not FReproduzindo);
end;

procedure TfrmPrototype.btnCancelarClick(Sender: TObject);
begin
  lstSequencia.Clear;
  memLog.Lines.Add('Reprodução cancelada pelo usuário.');
  AtualizaBotoes;
end;

procedure TfrmPrototype.btnIniciarClick(Sender: TObject);
var
  LNotas: TArray<string>;
  i: Integer;
  LNota: TNotaMusical;
begin
  if FSequencia = EmptyStr then
  begin
    ShowMessage('Selecione pelo menos uma nota.');
    Exit;
  end;

  memLog.Clear;
  FReproduzindo := True;
  AtualizaBotoes;

  LNotas := FSequencia.Split([' '], TStringSplitOptions.ExcludeEmpty);

  for I := 0 to High(LNotas) do
  begin
    if not FReproduzindo then
      Break;

    LNota := TPartitura.GetNota(LNotas[I]); // Prototype em ação
    if Assigned(LNota) then
    try
      memLog.Lines.Add(
        Format('Tocando %d: %s (instância %p, classe %s)',
          [I + 1, LNotas[I], Pointer(LNota), LNota.ClassName])
      );
    finally
      FreeAndNil(LNota);
    end
    else
      memLog.Lines.Add(Format('Nota "%s" não encontrada. ', [LNotas[I]]));

    Application.ProcessMessages;
    Sleep(400);
  end;

  FReproduzindo := False; // <-- terminou de tocar
  AtualizaBotoes;
end;

procedure TfrmPrototype.btnLimparClick(Sender: TObject);
begin
  FReproduzindo := False;
  FSequencia := EmptyStr;
  lstSequencia.Clear;
  memLog.Clear;
  AtualizaBotoes;
end;

procedure TfrmPrototype.FormCreate(Sender: TObject);
begin
  FSequencia := EmptyStr;
  FReproduzindo := False;


  btnDo.OnClick := ImgNotaClick;
  btnRe.OnClick := ImgNotaClick;
  btnMi.OnClick := ImgNotaClick;
  btnFa.OnClick := ImgNotaClick;
  btnSol.OnClick := ImgNotaClick;
  btnLa.OnClick := ImgNotaClick;
  btnSi.OnClick := ImgNotaClick;

  AtualizaBotoes;
end;

procedure TfrmPrototype.ImgNotaClick(Sender: TObject);
var
  LNota: string;
begin
  if not (Sender is TImage) then
    Exit;

  LNota := TImage(Sender).Hint;
  if LNota = '' then
    Exit;

  if FSequencia = '' then
    FSequencia := LNota
  else
    FSequencia := FSequencia + ' ' + LNota;

  lstSequencia.Clear;
  lstSequencia.Items.Add(FSequencia);

  AtualizaBotoes;
end;

procedure TfrmPrototype.TocarNota(const ANomeNota: string);
var
  LPath: string;
begin
  // pasta do EXE, ex: C:\projetos\EstudandoGOF\bin\
  // "..\lib\sons\" -> sobe 1 nível e entra em lib\sons
  LPath := ExpandFileName(
    ExtractFilePath(ParamStr(0)) + '..\lib\sons\' + ANomeNota + '.wav'
  );

  // opcional: pra conferir se o arquivo existe
  // if not FileExists(LPath) then
  // begin
  //   memLog.Lines.Add('Arquivo de áudio não encontrado: ' + LPath);
  //   Exit;
  // end;

  PlaySound(PChar(LPath), 0, SND_FILENAME or SND_ASYNC or SND_NODEFAULT);
end;

end.
