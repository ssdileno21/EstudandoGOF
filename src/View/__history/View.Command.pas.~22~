unit View.Command;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, View.Default, Vcl.StdCtrls, Vcl.ExtCtrls,
  System.ImageList, Vcl.ImgList, Behavioral.Command.Calculadora, Behavioral.Command.Invoker;

type
  TOperacaoPendente = (opNone, opAdd, opSub);

  TfrmCommand = class(TfrmDefault)
    Panel1: TPanel;
    Panel2: TPanel;
    memLog: TMemo;
    edtDisplay: TEdit;
    Label1: TLabel;
    btnMais: TButton;
    btn7: TButton;
    btn8: TButton;
    btn9: TButton;
    btn4: TButton;
    btn5: TButton;
    btn6: TButton;
    btn1: TButton;
    btn2: TButton;
    btn3: TButton;
    btn0: TButton;
    btnVirgula: TButton;
    btnMenos: TButton;
    btnTotal: TButton;
    btnClear: TButton;
    ImageList1: TImageList;
    btnUndo: TButton;
    procedure FormCreate(Sender: TObject);
    procedure FormDestroy(Sender: TObject);
    procedure btnVirgulaClick(Sender: TObject);
    procedure btnMaisClick(Sender: TObject);
    procedure DigitClick(Sender: TObject);
    procedure btnMenosClick(Sender: TObject);
    procedure btnTotalClick(Sender: TObject);
    procedure btnClearClick(Sender: TObject);
    procedure btnUndoClick(Sender: TObject);
  private
    { Private declarations }
    FCalc        : TCalculadora;
    FInvoker     : TInvoker;
    FPendente    : TOperacaoPendente;
    FDigitando   : Boolean;

    function  TextoParaInteiro: Integer;
    procedure LimparEntrada;
    procedure AtualizarDisplayComTotal;
    procedure Log(const AMsg: string);
    procedure WireDigits;
    procedure AplicarPendenteComEntrada; // aplica +/− N via Command
    procedure PrepararOperacao(AOp: TOperacaoPendente);
  public
    { Public declarations }
  end;

var
  frmCommand: TfrmCommand;

implementation

{$R *.dfm}

uses Behavioral.Command.Soma, Behavioral.Command.Subtracao;

procedure TfrmCommand.AplicarPendenteComEntrada;
var
  LNumero, LAntes: Integer;
begin
  // Aplica a operação pendente com o número digitado, via Command
  if (FPendente = opNone) or (not FDigitando) then
    Exit;

  LNumero := TextoParaInteiro;
  LAntes := FCalc.Valor;

  case FPendente of
    opAdd:
      begin
        FInvoker.Compute(TSoma.Create(FCalc, LNumero));
        Log(Format('= (aplica +%d)  %d -> %d  (stack=%d)', [LNumero, LAntes, FCalc.Valor, FInvoker.Count]));
      end;
    opSub:
      begin
        FInvoker.Compute(TSubtracao.Create(FCalc, LNumero));
        Log(Format('= (aplica -%d)  %d -> %d  (stack=%d)', [LNumero, LAntes, FCalc.Valor, FInvoker.Count]));
      end;
  end;

  AtualizarDisplayComTotal;
  LimparEntrada;
  FPendente := opNone;
end;

procedure TfrmCommand.AtualizarDisplayComTotal;
begin
  edtDisplay.Text := IntToStr(FCalc.Valor);
end;

procedure TfrmCommand.btnClearClick(Sender: TObject);
begin
  FCalc.Reset;
  FreeAndNil(FInvoker);
  FInvoker := TInvoker.Create;
  FPendente := opNone;

  LimparEntrada;
  AtualizarDisplayComTotal;
  Log('Clear: zera total e histórico do Invoker.');
end;

procedure TfrmCommand.btnMaisClick(Sender: TObject);
var
  V: Integer;
begin
  inherited;

  V := TextoParaInteiro;
  FInvoker.Compute(TSoma.Create(FCalc, V));
  Log(Format('Execute: +%d  -> Total = %d', [V, FCalc.Valor]));
  LimparEntrada;
  AtualizarDisplayComTotal;
end;

procedure TfrmCommand.btnMenosClick(Sender: TObject);
var
  V: Integer;
begin
  inherited;

  V := TextoParaInteiro;
  FInvoker.Compute(TSubtracao.Create(FCalc, V));
  Log(Format('Execute: -%d  -> Total = %d', [V, FCalc.Valor]));
  LimparEntrada;
  AtualizarDisplayComTotal;
end;

procedure TfrmCommand.btnTotalClick(Sender: TObject);
var
  N, Antes: Integer;
  OpChar: string;
begin
  // aplica a operação PENDENTE com o número digitado (estilo calculadora)
  if FPendente = opNone then
  begin
    AtualizarDisplayComTotal;
    Log(Format('=  (sem operação pendente) -> Total=%d', [FCalc.Valor]));
    Exit;
  end;

  N := TextoParaInteiro;
  Antes := FCalc.Valor;

  case FPendente of
    opAdd:  begin FInvoker.Compute(TSoma.Create(FCalc, N));  OpChar := '+'; end;
    opSub:  begin FInvoker.Compute(TSubtracao.Create(FCalc, N)); OpChar := '-'; end;
  end;

  Log(Format('=  (aplica %s%d)  Antes=%d -> Depois=%d  (stack=%d)',
      [OpChar, N, Antes, FCalc.Valor, FInvoker.Count]));

  FPendente := opNone;
  LimparEntrada;
  AtualizarDisplayComTotal;
end;

procedure TfrmCommand.btnUndoClick(Sender: TObject);
var
  Antes: Integer;
begin
  Antes := FCalc.Valor;
  FInvoker.Undo(1);
  Log(Format('Undo  (desfaz último comando)  Antes=%d -> Depois=%d  (stack=%d)',
      [Antes, FCalc.Valor, FInvoker.Count]));
  AtualizarDisplayComTotal;
end;

procedure TfrmCommand.btnVirgulaClick(Sender: TObject);
begin
  if Pos(',', edtDisplay.Text) = 0 then
  begin
    if not FDigitando then
      edtDisplay.Text := '0';
    edtDisplay.Text := edtDisplay.Text + ',';
    FDigitando := True;
  end;
end;

procedure TfrmCommand.DigitClick(Sender: TObject);
var
  LDigito: Char;
begin
  LDigito := Char(Ord('0') + TButton(Sender).Tag);
  if (edtDisplay.Text = '0') or (not FDigitando) then
    edtDisplay.Text := LDigito
  else
    edtDisplay.Text := edtDisplay.Text + LDigito;

  FDigitando := True;
end;

procedure TfrmCommand.FormCreate(Sender: TObject);
begin
  inherited;

  FCalc      := TCalculadora.Create;
  FInvoker   := TInvoker.Create;
  FPendente  := opNone;
  FDigitando := False;

  edtDisplay.ReadOnly  := True;
  // edtDisplay.Alignment := taRightJustify;
  edtDisplay.Text      := '0';

  memLog.Clear; memLog.ScrollBars := ssVertical;

  WireDigits;

  // garante handlers (caso DFM não tenha ligado)
  btnTotal.OnClick := btnTotalClick;
  btnClear.OnClick := btnClearClick;
  btnUndo.OnClick  := btnUndoClick;

  Log('Command: a tela cria comandos (TSoma/TSubtracao), envia ao Invoker e pode desfazer com Undo.');
end;

procedure TfrmCommand.FormDestroy(Sender: TObject);
begin
  FreeAndNil(FInvoker);
  FreeAndNil(FCalc);
  inherited;
end;

procedure TfrmCommand.LimparEntrada;
begin
  edtDisplay.Text := '0';
  FDigitando := False;
end;

procedure TfrmCommand.Log(const AMsg: string);
begin
  memLog.Lines.Add(AMsg);
end;

procedure TfrmCommand.PrepararOperacao(AOp: TOperacaoPendente);
begin

end;

function TfrmCommand.TextoParaInteiro: Integer;
begin
  Result := StrToIntDef(StringReplace(edtDisplay.Text, ',', '', []), 0);
end;

procedure TfrmCommand.WireDigits;
var
  Btns: array[0..9] of TButton;
  I: Integer;
begin
  Btns[0] := btn0;  Btns[1] := btn1;  Btns[2] := btn2;  Btns[3] := btn3;  Btns[4] := btn4;
  Btns[5] := btn5;  Btns[6] := btn6;  Btns[7] := btn7;  Btns[8] := btn8;  Btns[9] := btn9;

  for I := 0 to High(Btns) do
  begin
    Btns[I].Caption := IntToStr(I);
    Btns[I].Tag     := I;
    Btns[I].OnClick := DigitClick;
  end;

  btnVirgula.Caption := ',';
  btnMais.Caption    := '+';
  btnMenos.Caption   := '-';
  btnTotal.Caption   := '=';
  btnClear.Caption   := 'C';
  btnUndo.Caption    := EmptyStr;
end;

end.
