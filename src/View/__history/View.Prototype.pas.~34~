unit View.Prototype;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, View.Default, Vcl.StdCtrls,
  Vcl.ExtCtrls, Vcl.Buttons;

type
  TfrmPrototype = class(TfrmDefault)
    GroupBox1: TGroupBox;
    Panel1: TPanel;
    btnSi: TImage;
    btnDo: TImage;
    btnRe: TImage;
    btnMi: TImage;
    btnFa: TImage;
    btnSol: TImage;
    btnLa: TImage;
    lstSequencia: TListBox;
    Panel2: TPanel;
    btnLimpar: TButton;
    btnCancelar: TButton;
    btnIniciar: TButton;
    memLog: TMemo;
    procedure FormCreate(Sender: TObject);
    procedure ImgNotaClick(Sender: TObject);
    procedure btnIniciarClick(Sender: TObject);
    procedure btnCancelarClick(Sender: TObject);
    procedure btnLimparClick(Sender: TObject);
  private
    { Private declarations }
    FSequencia: string;
    FReproduzindo: Boolean;
    procedure AtualizaBotoes;
  public
    { Public declarations }
  end;

var
  frmPrototype: TfrmPrototype;

implementation

{$R *.dfm}

uses Prototype.NotaMusical, Prototype.Partitura;

{ TfrmPrototype }


procedure TfrmPrototype.AtualizaBotoes;
begin
  btnIniciar.Enabled := (lstSequencia.Count > 0) and (not FReproduzindo);
  btnCancelar.Enabled := FReproduzindo;
  btnLimpar.Enabled := (lstSequencia.Count > 0) and (not FReproduzindo);
end;

procedure TfrmPrototype.btnCancelarClick(Sender: TObject);
begin
  lstSequencia.Clear;
  memLog.Lines.Add('Reprodução cancelada pelo usuário.');
  AtualizaBotoes;
end;

procedure TfrmPrototype.btnIniciarClick(Sender: TObject);
var
  LNotas: TArray<string>;
  i: Integer;
  LNota: TNotaMusical;
begin
  if FSequencia = EmptyStr then
  begin
    ShowMessage('Selecione pelo menos uma nota.')
  end;

  memLog.Clear;
  FReproduzindo := True;
  AtualizaBotoes;

  LNotas := FSequencia.Split([' '],TStringSplitOptions.ExcludeEmpty);

  for i := 0 to High(LNotas) do
  begin
    if not FReproduzindo then
      Break;

    LNota := TPartitura.GetNota(LNotas[I]);
      if Assigned(LNotas) then
      try
        memLog.Lines.Add(
          Format('Tocando %d: %s (instância %p, classe %s)',
            [i + 1, LNotas[I], Pointer(LNota), LNota.ClassName])
        );
      finally
        FreeAndNil(LNota);
      end
      else
        memLog.Lines.Add(Format('Nota "%s" não encontrada. ', [LNotas[i]]));

      Application.ProcessMessages;
      Sleep(400);

  end;

  FReproduzindo := True;
  AtualizaBotoes;
end;

procedure TfrmPrototype.btnLimparClick(Sender: TObject);
begin
  FReproduzindo := False;
  FSequencia := EmptyStr;
  lstSequencia.Clear;
  memLog.Clear;
  AtualizaBotoes;
end;

procedure TfrmPrototype.FormCreate(Sender: TObject);
begin
  FSequencia := EmptyStr;
  FReproduzindo := False;


  btnDo.OnClick := ImgNotaClick;
  btnRe.OnClick := ImgNotaClick;
  btnMi.OnClick := ImgNotaClick;
  btnFa.OnClick := ImgNotaClick;
  btnSol.OnClick := ImgNotaClick;
  btnLa.OnClick := ImgNotaClick;
  btnSi.OnClick := ImgNotaClick;

  AtualizaBotoes;
end;

procedure TfrmPrototype.ImgNotaClick(Sender: TObject);
var
  LNota: string;
begin
  if not (Sender is TImage) then
    Exit;

  LNota := TImage(Sender).Hint;
  if LNota = EmptyStr then
    Exit;

  if FSequencia = EmptyStr then
    FSequencia := LNota
  else
    FSequencia := FSequencia + ' ' + LNota;
end;

end.
